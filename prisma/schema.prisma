generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Owner {
  id         String  @id @default(cuid())
  firebaseId String  @unique
  name       String?
  email      String?
  photoURL   String?
  teamSize   String? // Team size for owner context (e.g., "just-me", "2-10", "11-50", "51-200", "200+")

  // Microsoft OAuth integration (bolted directly onto Owner)
  microsoftAccessToken  String? // Microsoft Graph access token
  microsoftRefreshToken String? // Refresh token for getting new access tokens
  microsoftExpiresAt    DateTime? // Token expiration timestamp
  microsoftEmail        String? // Microsoft account email (for display)
  microsoftDisplayName  String? // Microsoft account display name (for display)
  microsoftTenantId     String? // Tenant ID extracted from ID token (for tenant-specific token refresh)

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  managedCompanies CompanyHQ[]     @relation("ManagerOf")
  ownedCompanies   CompanyHQ[]     @relation("OwnerOf")
  emailActivities  EmailActivity[] // Outreach email tracking
  assessments      Assessment[] // Growth assessments

  @@map("owners")
}

model EmailActivity {
  id        String   @id @default(cuid())
  ownerId   String   @map("owner_id")
  contactId String?  @map("contact_id")
  tenantId  String?  @map("tenant_id")
  email     String
  subject   String
  body      String
  event     String? // last known state: delivered, opened, clicked, bounced, etc.
  messageId String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner Owner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([messageId])
  @@index([contactId])
  @@map("email_activities")
}

model CompanyHQ {
  id                   String                  @id @default(cuid())
  companyName          String
  companyStreet        String? // Street address
  companyCity          String? // City
  companyState         String? // State
  companyWebsite       String? // Website URL (for LinkedIn extraction, etc.)
  whatYouDo            String? // What the company does (description)
  companyIndustry      String?
  companyAnnualRev     Float?
  yearsInBusiness      Int?
  teamSize             String? // Team size for company (e.g., "just-me", "2-10", "11-50", "51-200", "200+")
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  ownerId              String? // Owner.id (for legacy Owner model) - optional for Contact-owned HQs
  contactOwnerId       String? // Contact.id (for Contact-owned HQs) - when Contact becomes owner
  managerId            String?
  companies            Company[]
  manager              Owner?                  @relation("ManagerOf", fields: [managerId], references: [id])
  owner                Owner?                  @relation("OwnerOf", fields: [ownerId], references: [id]) // Made optional
  contactOwner         Contact?                @relation("ContactOwnedHQs", fields: [contactOwnerId], references: [id]) // Contact who owns this HQ
  contactLists         ContactList[]
  contacts             Contact[]
  proposals            Proposal[]
  products             Product[]
  personas             Persona[]
  assessments          Assessment[]
  memberships          CompanyMembership[] // Junction table for multi-HQ access
  domainRegistry       DomainRegistry? // Domain registry entry (one-to-one)
  deliverables         ConsultantDeliverable[] // Client delivery deliverables
  phaseTemplates       PhaseTemplate[]
  deliverableTemplates DeliverableTemplate[]
  workPackages         WorkPackage[] // Work packages scoped to this HQ
  blogs                Blog[]
  templates            Template[]
  eventPlans           EventPlan[]
  cleDecks             CleDeck[]
  landingPages         LandingPage[]

  @@map("company_hqs")
}

model Company {
  id              String        @id @default(cuid())
  companyHQId     String
  companyName     String
  address         String?
  industry        String?
  website         String? // Website URL (inferred from email domain or manually entered)
  revenue         Float?
  yearsInBusiness Int?
  proposalId      String?
  contractId      String?
  invoiceId       String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  companyHQ       CompanyHQ     @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  contacts        Contact[]
  proposals       Proposal[] // Proposals linked to this company
  workPackages    WorkPackage[] // Work packages for this company

  @@map("companies")
}

model ContactList {
  id          String    @id @default(cuid())
  companyId   String
  name        String
  description String?
  type        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyHQ   CompanyHQ @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contacts    Contact[]

  @@map("contact_lists")
}

model Contact {
  id                  String    @id @default(cuid())
  crmId               String // CompanyHQId (tenant identifier) - renamed from companyId for clarity
  firstName           String?
  lastName            String?
  fullName            String? // Full name from enrichment
  goesBy              String?
  email               String?   @unique
  phone               String?
  title               String?
  seniority           String? // Seniority level from enrichment
  department          String? // Department from enrichment
  linkedinUrl         String? // LinkedIn URL from enrichment
  city                String? // City from enrichment
  state               String? // State from enrichment
  country             String? // Country from enrichment
  contactCompanyId    String? // Company they work for (prospect/client company)
  buyerDecision       String?
  howMet              String?
  notes               String? // Notes/context about the contact
  contactListId       String?
  domain              String? // Domain inferred from email (e.g., "businesspointlaw.com")
  companyName         String? // Company name from enrichment
  companyDomain       String? // Company domain from enrichment (e.g., "example.com")
  enrichmentSource    String? // Source of enrichment (e.g., "Lusha", "Apollo")
  enrichmentFetchedAt DateTime? // When enrichment was fetched
  enrichmentPayload   Json? // Full enrichment payload
  createdById         String? // User who created this contact

  // Client Portal Activation
  firebaseUid     String?   @unique // Firebase Auth UID
  clientPortalUrl String?   @default("https://clientportal.ignitegrowth.biz") // Portal URL for this contact
  isActivated     Boolean   @default(false) // Has completed activation flow
  activatedAt     DateTime? // When activation was completed

  // Elevation to Owner
  ownerId String? // Contact.id (self-reference when they become owner of their own HQ)
  role    String  @default("contact") // "contact" | "owner"

  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  companyHQ      CompanyHQ               @relation(fields: [crmId], references: [id])
  contactCompany Company?                @relation(fields: [contactCompanyId], references: [id])
  contactList    ContactList?            @relation(fields: [contactListId], references: [id])
  pipeline       Pipeline?
  deliverables   ConsultantDeliverable[]
  invites        InviteToken[] // Invite tokens for activation
  ownedHQs       CompanyHQ[]             @relation("ContactOwnedHQs") // HQs owned by this Contact
  proposals      Proposal[] // Proposals for this contact
  workPackages   WorkPackage[] // Work packages for this contact
  // Note: memberships are queried via firebaseUid, not direct relation (due to nullable firebaseUid)

  @@index([email])
  @@index([firebaseUid])
  @@index([ownerId])
  @@index([role])
  @@index([domain])
  @@map("contacts")
}

model DomainRegistry {
  id              String   @id @default(cuid())
  domain          String   @unique // Normalized domain (e.g., "businesspointlaw.com")
  normalizedName  String? // Normalized company name (e.g., "Business Point Law")
  companyHqId     String   @unique // CompanyHQ this domain belongs to
  firstSeen       DateTime @default(now())
  lastSeen        DateTime @updatedAt
  confidenceScore Float?   @default(1.0) // Confidence that this domain belongs to this CompanyHQ

  companyHQ CompanyHQ @relation(fields: [companyHqId], references: [id], onDelete: Cascade)

  @@index([domain])
  @@index([companyHqId])
  @@map("domain_registry")
}

model Product {
  id                    String       @id @default(cuid())
  companyHQId           String
  name                  String
  description           String?
  valueProp             String?
  price                 Float? // Price in base currency
  priceCurrency         String?      @default("USD") // Currency code (USD, EUR, etc.)
  pricingModel          String? // one-time, recurring, usage-based, freemium, custom
  category              String? // Category or type of product/service
  deliveryTimeline      String? // How long it takes to deliver
  targetMarketSize      String? // enterprise, mid-market, small-business, startup, individual
  salesCycleLength      String? // immediate, short, medium, long, very-long
  features              String? // Key features (free text)
  competitiveAdvantages String? // Competitive advantages (free text)
  targetedTo            String? // Persona ID that this product is targeted to
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  companyHQ             CompanyHQ    @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  personas              Persona[]
  productFits           ProductFit[]

  @@map("products")
}

model Pipeline {
  id        String   @id @default(cuid())
  contactId String   @unique
  pipeline  String
  stage     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("pipelines")
}

model Proposal {
  id          String    @id @default(cuid())
  title       String
  companyHQId String // Multi-tenancy - scoped to CompanyHQ (hqId)
  companyHQ   CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)

  // Client information
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Proposal details
  estimatedStart DateTime
  status         String   @default("draft") // "draft" | "active" | "approved" | "rejected"
  totalPrice     Float?
  purpose        String? // Purpose/description of the proposal

  // Legacy JSON fields (for backward compatibility during migration)
  phases       Json? // DEPRECATED: Use ProposalPhase relation instead
  milestones   Json? // DEPRECATED
  compensation Json? // Compensation object (total, currency, breakdown, paymentSchedule)

  // Metadata
  dateIssued DateTime?
  preparedBy String?

  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  proposalPhases ProposalPhase[]
  deliverables   ConsultantDeliverable[]

  @@map("proposals")
}

model PhaseTemplate {
  id                   String                     @id @default(cuid())
  companyHQId          String
  companyHQ            CompanyHQ                  @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  name                 String
  description          String?
  defaultDurationWeeks Int?                       @default(3)
  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  phaseDeliverables    PhaseDeliverableTemplate[]
  proposalPhases       ProposalPhase[]

  @@map("phase_templates")
}

model DeliverableTemplate {
  id                   String                     @id @default(cuid())
  companyHQId          String
  companyHQ            CompanyHQ                  @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  name                 String
  description          String?
  defaultQuantity      Int?                       @default(1)
  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  phaseDeliverables    PhaseDeliverableTemplate[]
  proposalDeliverables ProposalDeliverable[]

  @@map("deliverable_templates")
}

model PhaseDeliverableTemplate {
  id                    String              @id @default(cuid())
  phaseTemplateId       String
  deliverableTemplateId String
  phaseTemplate         PhaseTemplate       @relation(fields: [phaseTemplateId], references: [id], onDelete: Cascade)
  deliverableTemplate   DeliverableTemplate @relation(fields: [deliverableTemplateId], references: [id], onDelete: Cascade)
  defaultQuantity       Int?                @default(1)
  order                 Int?                @default(0)
  createdAt             DateTime            @default(now())

  @@unique([phaseTemplateId, deliverableTemplateId])
  @@map("phase_deliverable_templates")
}

model ProposalPhase {
  id              String                @id @default(cuid())
  proposalId      String
  proposal        Proposal              @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  phaseTemplateId String?
  phaseTemplate   PhaseTemplate?        @relation(fields: [phaseTemplateId], references: [id], onDelete: SetNull)
  name            String
  description     String?
  durationWeeks   Int
  order           Int
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  deliverables    ProposalDeliverable[]

  @@index([proposalId])
  @@map("proposal_phases")
}

model ProposalDeliverable {
  id                    String               @id @default(cuid())
  proposalPhaseId       String
  proposalPhase         ProposalPhase        @relation(fields: [proposalPhaseId], references: [id], onDelete: Cascade)
  deliverableTemplateId String?
  deliverableTemplate   DeliverableTemplate? @relation(fields: [deliverableTemplateId], references: [id], onDelete: SetNull)
  name                  String
  description           String?
  quantity              Int                  @default(1)
  order                 Int?                 @default(0)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  @@index([proposalPhaseId])
  @@map("proposal_deliverables")
}

model Persona {
  id              String      @id @default(cuid())
  companyHQId     String
  personName      String
  title           String
  headline        String?
  seniority       String?
  industry        String?
  subIndustries   String[]
  company         String?
  companySize     String?
  annualRevenue   String?
  location        String?
  description     String?
  whatTheyWant    String?
  painPoints      String[]
  risks           String[]
  decisionDrivers String[]
  buyerTriggers   String[]
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  companyHQ       CompanyHQ   @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  productFit      ProductFit?
  bdIntel         BdIntel?
  product         Product?    @relation(fields: [productId], references: [id])
  productId       String?

  @@map("personas")
}

model ProductFit {
  id                 String   @id @default(cuid())
  personaId          String   @unique
  productId          String
  valuePropToThem    String
  alignmentReasoning String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  persona            Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)
  product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_fits")
}

model BdIntel {
  id                    String   @id @default(cuid())
  personaId             String   @unique
  fitScore              Int // 0-100
  painAlignmentScore    Int // 0-100
  workflowFitScore      Int // 0-100
  urgencyScore          Int // 0-100
  adoptionBarrierScore  Int // 0-100
  risks                 Json? // Array of risks
  opportunities         Json? // Array of opportunities
  recommendedTalkTrack  String?
  recommendedSequence   String?
  recommendedLeadSource String?
  finalSummary          String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  persona               Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@map("bd_intels")
}

model ConsultantDeliverable {
  id        String  @id @default(cuid())
  contactId String // Link to Contact (the client)
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // What we're delivering
  title       String
  description String?
  category    String? // "foundation", "integration", "enrichment", etc.
  type        String? // "persona", "blog", "upload", etc. - deliverable type

  // Work content (stored as JSON for flexibility)
  workContent Json? // Actual work artifact (persona data, blog content, etc.)

  // Status tracking
  status String @default("pending") // "pending" | "in-progress" | "completed" | "blocked"

  // Link to proposal/milestone (optional - can start fresh)
  proposalId  String?
  proposal    Proposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)
  milestoneId String? // Reference to milestone in Proposal.milestones JSON (e.g., "milestone-1", "week-4")

  // Delivery tracking
  dueDate     DateTime?
  completedAt DateTime?
  notes       String?

  // Tenant scoping (for client delivery architecture)
  companyHQId      String // Always linked to owner's company (tenant boundary)
  companyHQ        CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  contactCompanyId String? // Link to contact's company (can derive from contact.contactCompanyId)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contactId])
  @@index([proposalId])
  @@index([companyHQId])
  @@map("consultant_deliverables")
}

enum WorkPackageStatus {
  ACTIVE
  COMPLETED
}

enum WorkItemType {
  BLOG
  PERSONA
  OUTREACH_TEMPLATE
  EVENT_CLE_PLAN
  CLE_DECK
  LANDING_PAGE
}

model WorkPackage {
  id               String     @id @default(cuid())
  contactId        String
  contact          Contact    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactCompanyId String?
  contactCompany   Company?   @relation(fields: [contactCompanyId], references: [id], onDelete: SetNull)
  companyHQId      String?
  companyHQ        CompanyHQ? @relation(fields: [companyHQId], references: [id], onDelete: SetNull)

  title       String
  description String?
  status      WorkPackageStatus @default(ACTIVE)

  items WorkPackageItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contactId])
  @@index([contactCompanyId])
  @@index([companyHQId])
  @@map("work_packages")
}

model WorkPackageItem {
  id            String      @id @default(cuid())
  workPackageId String
  workPackage   WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  // Human-facing label
  deliverableName String // e.g. "Blog Posts", "Personas"
  type            WorkItemType
  quantity        Int // number owed

  // Actual artifacts produced (arrays of artifact IDs)
  blogIds        String[] @default([])
  personaIds     String[] @default([])
  templateIds    String[] @default([])
  eventPlanIds   String[] @default([])
  cleDeckIds     String[] @default([])
  landingPageIds String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workPackageId])
  @@index([type])
  @@map("work_package_items")
}

// Artifact Models (standalone content models)
model Blog {
  id          String    @id @default(cuid())
  companyHQId String
  companyHQ   CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  title       String
  content     String?
  author      String?
  published   Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([companyHQId])
  @@index([published])
  @@map("blogs")
}

model Template {
  id          String    @id @default(cuid())
  companyHQId String
  companyHQ   CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  name        String
  subject     String?
  body        String?
  type        String? // "email", "sms", etc.
  published   Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([companyHQId])
  @@index([published])
  @@map("templates")
}

model EventPlan {
  id          String    @id @default(cuid())
  companyHQId String
  companyHQ   CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  eventName   String
  date        DateTime?
  location    String?
  agenda      String?
  description String?
  published   Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([companyHQId])
  @@index([published])
  @@map("event_plans")
}

model CleDeck {
  id          String    @id @default(cuid())
  companyHQId String
  companyHQ   CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  title       String
  slides      Json? // Array of slide objects
  presenter   String?
  description String?
  published   Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([companyHQId])
  @@index([published])
  @@map("cle_decks")
}

model LandingPage {
  id          String    @id @default(cuid())
  companyHQId String
  companyHQ   CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  title       String
  url         String?
  content     Json? // Page content structure
  description String?
  published   Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([companyHQId])
  @@index([published])
  @@map("landing_pages")
}

model ProspectCandidate {
  id          String   @id @default(cuid())
  userId      String
  firstName   String?
  lastName    String?
  companyName String?
  domain      String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([status])
  @@map("prospect_candidates")
}

model Assessment {
  id          String     @id @default(cuid())
  ownerId     String
  owner       Owner      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  companyHQId String? // Optional: Link to CompanyHQ
  companyHQ   CompanyHQ? @relation(fields: [companyHQId], references: [id], onDelete: SetNull)

  // Assessment responses
  name                 String
  company              String
  industry             String?
  workTooMuch          String? // "always" | "often" | "sometimes" | "rarely"
  assignTasks          String? // "never" | "rarely" | "sometimes" | "always"
  wantMoreClients      String? // "yes" | "maybe" | "no"
  revenueGrowthPercent Float? // Percentage (e.g., 25 for 25%)
  totalVolume          Float? // Total revenue/volume
  bdSpend              Float? // Business development spend

  // Calculated results
  score               Int? // 0-100 score
  scoreInterpretation String? // "High Growth Potential" | "Medium Growth Potential" | etc.
  relateWithUser      String? // First paragraph of insights
  growthNeeds         String? // Second paragraph of insights
  rawGptResponse      String? // Full GPT response

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([companyHQId])
  @@map("assessments")
}

model ClientUpload {
  id           String   @id @default(cuid())
  ownerId      String
  fileUrl      String
  originalName String
  fileType     String?
  size         Int?
  status       String   @default("stored")
  createdAt    DateTime @default(now())

  @@index([ownerId])
  @@map("client_uploads")
}

model InviteToken {
  id        String   @id @default(cuid())
  contactId String
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([contactId])
  @@index([email])
  @@map("invite_tokens")
}

model CompanyMembership {
  id          String   @id @default(cuid())
  userId      String // Contact.firebaseUid (maps to Firebase Auth UID) - stored as string
  companyHqId String
  role        String // "client" | "owner" | "admin"
  isPrimary   Boolean  @default(false) // Primary HQ for this user
  createdAt   DateTime @default(now())

  // Note: userId stores firebaseUid as string - query Contact manually via firebaseUid
  // Prisma doesn't support relations on nullable unique fields easily
  companyHQ CompanyHQ @relation(fields: [companyHqId], references: [id], onDelete: Cascade)

  @@unique([userId, companyHqId]) // Prevent duplicate memberships
  @@index([userId])
  @@index([companyHqId])
  @@index([userId, companyHqId])
  @@map("company_memberships")
}
